<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <!--[if lte IE 8]>
    <script src="assets/js/ie/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="assets/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="assets/css/ie9.css"/>
    <![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="assets/css/ie8.css"/>
    <![endif]-->
    <noscript>
        <link rel="stylesheet" href="assets/css/noscript.css"/>
    </noscript>
</head>
<body>
<div id="wrapper">
    <header id="header">
        <h1><strong class="js-album-title"></strong></h1>
    </header>
    <div id="main" class="js-picture-list"></div>
</div>
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/lodash.min.js"></script>
<script src="assets/js/skel.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>
<!--[if lte IE 8]>
<script src="assets/js/ie/respond.min.js"></script>
<![endif]-->
<script>

  var indexUrl = _.defaultTo($.fn.queryParam('i'), '/pics/index/index.json');
  var $container = $('.js-picture-list');
  var $title = $('.js-album-title');

  function mkPath (path) {
      return _.join(path, "/")
  }

  function basename (path) {
      return _.last(_.split(path, "/"));
  }

  $.getJSON(indexUrl)
    .then(function (response) {
      console.log(response);

      $container.empty();

      $title.html(_.get(response, 'title', ''));

      var albums = _.get(response, 'albums', []);
      var items  = _.get(response, 'items', []);
      if (!_.size(albums) && _.size(items)) {
        window.location.href = '/album/index.html?i=' + indexUrl;
        return;
      }

      _.each(albums, function (album) {
        var thumbUrl = mkPath([album.path, album.thumb]);
        $("<article class=\"thumb\">" +
              "<a href=\"/index.html?i=/" + album.index + "\" class=\"image\">" +
                "<img src=\"" + thumbUrl + "\" alt=\"\" />" +
              "</a>" +
              "<h2>" + album.title + "</h2>" +
          "</article>").appendTo($container);
      });

      var items = _.get(response, 'items', []);
      if (_.size(items)) {
          var thumbFilename = basename(_.first(items));
          var thumbUrl = mkPath([response.thumb, thumbFilename]);
        $("<article class=\"thumb\">" +
              "<a href=\"/album/index.html?i=" + indexUrl + "\" class=\"image\">" +
                "<img src=\"" + thumbUrl + "\" alt=\"" + thumbFilename + "\" />" +
              "</a>" +
              "<h2>" + response.title + "</h2>" +
          "</article>").appendTo($container);
      }

      initMain();
    });
</script>
</body>
</html>
